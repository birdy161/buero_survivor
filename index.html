<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>üè¢ B√ºro Survivors v3</title>
<style>*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}html,body{width:100%;height:100%;overflow:hidden;background:#111;font-family:'Segoe UI',system-ui,sans-serif;touch-action:none}canvas{display:block}</style>
</head>
<body>
<canvas id="gc"></canvas>
<script>
const C=document.getElementById('gc'),X=C.getContext('2d');
let VW,VH,DPR=Math.min(devicePixelRatio,2);
function resize(){VW=innerWidth;VH=innerHeight;C.width=VW*DPR;C.height=VH*DPR;C.style.width=VW+'px';C.style.height=VH+'px';X.setTransform(DPR,0,0,DPR,0,0)}
resize();addEventListener('resize',resize);
const PI=Math.PI,PI2=PI*2,rng=(a,b)=>Math.random()*(b-a)+a,rngI=(a,b)=>Math.floor(rng(a,b+1));
const dst=(a,b)=>Math.hypot(b.x-a.x,b.y-a.y),ang=(a,b)=>Math.atan2(b.y-a.y,b.x-a.x),lerp=(a,b,t)=>a+(b-a)*t,clamp=(v,l,h)=>Math.max(l,Math.min(h,v));
const fmtT=s=>{const m=Math.floor(s/60),c=Math.floor(s%60);return m+':'+(c<10?'0':'')+c};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUDIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let AC=null;function initA(){if(!AC)try{AC=new(AudioContext||webkitAudioContext)}catch(e){}}
function sfx(t){if(!AC)return;try{const o=AC.createOscillator(),g=AC.createGain();o.connect(g);g.connect(AC.destination);const n=AC.currentTime;
if(t==='boom'){const s=AC.createBufferSource(),b=AC.createBuffer(1,AC.sampleRate*.25,AC.sampleRate),d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.5);s.buffer=b;const gn=AC.createGain();gn.gain.setValueAtTime(.13,n);gn.gain.exponentialRampToValueAtTime(.001,n+.25);s.connect(gn);gn.connect(AC.destination);s.start(n);return}
const P={shoot:[600,150,.08,'square'],hit:[300,80,.08,'sawtooth'],kill:[500,900,.07,'square'],xp:[700,1400,.04,'sine'],
lvl:[523,1047,.1,'sine'],coin:[988,1319,.05,'sine'],hurt:[200,50,.09,'sawtooth'],boss:[80,60,.13,'sawtooth'],
power:[440,880,.08,'sine'],combo:[800,1600,.07,'triangle'],freeze:[1200,400,.06,'sine']};
const p=P[t];if(!p)return;o.type=p[3];o.frequency.setValueAtTime(p[0],n);o.frequency.exponentialRampToValueAtTime(p[1],n+.12);
g.gain.setValueAtTime(p[2],n);g.gain.exponentialRampToValueAtTime(.001,n+.15);o.start(n);o.stop(n+.16)}catch(e){}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SAVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let save={coins:0,totalKills:0,games:0,bestTime:0,bestWave:0,bestKills:0,bestCombo:0,up:{hp:0,dmg:0,spd:0,armor:0,luck:0,xp:0},unlocked:[0],run:null};
const SAVE_KEY='bs5',COOKIE_MAX_AGE=60*60*24*365*5;
function getCookie(name){
const v=('; '+document.cookie).split('; '+name+'=');
if(v.length<2)return null;
return v.pop().split(';').shift();
}
function loadS(){
try{
const c=getCookie(SAVE_KEY);
if(c){save={...save,...JSON.parse(decodeURIComponent(c))};return}
const s=localStorage.getItem(SAVE_KEY); // one-time migration from old saves
if(s){save={...save,...JSON.parse(s)};doS();localStorage.removeItem(SAVE_KEY)}
}catch(e){}
}
function doS(){
try{
document.cookie=`${SAVE_KEY}=${encodeURIComponent(JSON.stringify(save))}; path=/; max-age=${COOKIE_MAX_AGE}; samesite=lax`;
}catch(e){}
}
loadS();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üèÜ COMBO SYSTEM ‚Äî Echte Belohnungen!
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Passive: +1.5% DMG per combo (max +100%), +0.8% speed per combo (max +30%)
// Milestones give coins, heals, explosions, shields
const COMBO_M=[
{at:5,name:'NICE!',col:'#FFD740',co:3,heal:0,pulse:0},
{at:10,name:'SUPER!',col:'#FFA726',co:8,heal:.05,pulse:60},
{at:20,name:'WAHNSINN!',col:'#FF7043',co:15,heal:.08,pulse:100},
{at:35,name:'LEGEND√ÑR!',col:'#FF5252',co:25,heal:.15,pulse:130},
{at:50,name:'B√úRO-GOTT!',col:'#E040FB',co:40,heal:.2,pulse:180},
{at:75,name:'UNM√ñGLICH!',col:'#00E5FF',co:60,heal:.5,pulse:220},
{at:100,name:'TRANSZENDENT!',col:'#FFD700',co:100,heal:1,pulse:300},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHARACTERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CHARS=[
{id:0,name:'Praktikant',emoji:'üë®‚Äçüíº',desc:'Ausgewogen',hp:85,spd:150,dmg:10,color:'#4CAF50',cost:0,wep:'pencil',spec:'coffee',sCD:15,sN:'‚òï Kaffeepause'},
{id:1,name:'IT-Admina',emoji:'üë©‚Äçüíª',desc:'Schnell & pr√§zise',hp:65,spd:190,dmg:12,color:'#2196F3',cost:120,wep:'mouse',spec:'reboot',sCD:12,sN:'üîÑ Neustart'},
{id:2,name:'Koch',emoji:'üë®‚Äçüç≥',desc:'Tank mit So√üe',hp:130,spd:110,dmg:16,color:'#FF9800',cost:200,wep:'food',spec:'soup',sCD:10,sN:'üçú Kantinenkeule'},
{id:3,name:'Hausmeister',emoji:'üßπ',desc:'Mopp-Fu Meister',hp:95,spd:140,dmg:13,color:'#9C27B0',cost:180,wep:'mop',spec:'sweep',sCD:13,sN:'üåä Gro√üputz'},
{id:4,name:'√Ñrztin',emoji:'üë©‚Äç‚öïÔ∏è',desc:'Passiv-Regen',hp:75,spd:148,dmg:9,color:'#E91E63',cost:300,wep:'syringe',spec:'immune',sCD:20,sN:'üìã Krankschreibung'},
{id:5,name:'CEO',emoji:'ü¶∏',desc:'OP. Teuer.',hp:170,spd:180,dmg:22,color:'#FFD700',cost:999,wep:'creditcard',spec:'nuke',sCD:25,sN:'üí∏ Massenentlassung'},
];
let selChar=0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ENEMIES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ET=[
{name:'Spam-Email',emoji:'üìß',hp:18,spd:115,dmg:7,sz:13,xp:5,co:1},
{name:'Meeting-Einladung',emoji:'üìã',hp:28,spd:80,dmg:10,sz:16,xp:8,co:2},
{name:'Papierstau',emoji:'üñ®Ô∏è',hp:50,spd:38,dmg:9,sz:22,xp:14,co:3,ranged:1},
{name:'Software-Bug',emoji:'üêõ',hp:20,spd:185,dmg:8,sz:13,xp:7,co:1},
{name:'Deadline',emoji:'üìÖ',hp:38,spd:165,dmg:18,sz:18,xp:12,co:3,charge:1},
{name:'Death by PPT',emoji:'üìä',hp:42,spd:48,dmg:5,sz:20,xp:11,co:2,aura:85},
{name:'Steuerbescheid',emoji:'üßæ',hp:32,spd:120,dmg:6,sz:16,xp:10,co:6},
{name:'W√ºtender Kunde',emoji:'üò§',hp:55,spd:75,dmg:22,sz:20,xp:13,co:3,charge:1},
{name:'√úberstunden',emoji:'üïê',hp:65,spd:42,dmg:15,sz:22,xp:16,co:4},
{name:'Endlos-Zoom',emoji:'üì±',hp:48,spd:55,dmg:4,sz:19,xp:12,co:3,aura:95},
{name:'Aktenschrank',emoji:'üóÑÔ∏è',hp:85,spd:32,dmg:26,sz:26,xp:20,co:5},
{name:'Compliance-Audit',emoji:'üîç',hp:55,spd:105,dmg:18,sz:18,xp:18,co:4},
];
const BT=[
{name:'DER MONTAG',emoji:'üì¶',hp:500,spd:60,dmg:24,sz:48,xp:80,co:40},
{name:'DER VORSTAND',emoji:'üëî',hp:900,spd:75,dmg:35,sz:50,xp:120,co:70},
{name:'UMSTRUKTURIERUNG',emoji:'üèóÔ∏è',hp:1400,spd:50,dmg:30,sz:55,xp:200,co:100},
{name:'DAS FINANZAMT',emoji:'üèõÔ∏è',hp:2200,spd:65,dmg:45,sz:60,xp:350,co:150},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üî´ WAFFEN ‚Äî Jede einzigartig & kreativ!
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WP={
pencil:{emoji:'‚úèÔ∏è',name:'Bleistift',ps:340,dm:1,rt:.4,col:'#FFD54F',
 desc:'3 Treffer ‚Üí NOTIZ-BURST (3x DMG)!',mech:'stack'},
mouse:{emoji:'üñ±Ô∏è',name:'Maus',ps:380,dm:1,rt:.25,col:'#42A5F5',
 desc:'4. Klick = DOPPELKLICK (3x DMG-AOE)!',mech:'multi'},
food:{emoji:'üçñ',name:'Schnitzel',ps:220,dm:1.4,rt:.55,col:'#FF9800',
 desc:'Hinterl√§sst Fettlache (Slow+DOT)!',mech:'grease'},
mop:{emoji:'üßπ',name:'Mopp',ps:270,dm:1.1,rt:.38,col:'#CE93D8',
 desc:'Knockback + nasser Boden (Rutschgefahr)!',mech:'wetfloor'},
syringe:{emoji:'üíâ',name:'Spritze',ps:360,dm:.85,rt:.32,col:'#F48FB1',
 desc:'Infiziert! Tod ‚Üí Kettenexplosion!',mech:'infect'},
creditcard:{emoji:'üí≥',name:'Kreditkarte',ps:420,dm:1.6,rt:.22,col:'#FFD700',
 desc:'Durchbohrt ALLE + droppt M√ºnzen!',mech:'goldrush'},
stapler:{emoji:'üìå',name:'Tacker',ps:450,dm:.5,rt:.1,col:'#EF5350',
 desc:'Rapid-Fire! Nagelt Feinde 0.5s fest!',mech:'pin'},
hotcoffee:{emoji:'‚òï',name:'Hei√üer Kaffee',ps:250,dm:1.1,rt:.5,col:'#795548',
 desc:'Splash + brennende Kaffeelache (DOT)!',mech:'burn'},
coldcoffee:{emoji:'üßä',name:'Kalter Kaffee',ps:300,dm:.7,rt:.33,col:'#29B6F6',
 desc:'Slow ‚Üí Doppelt-Hit = EINFRIEREN 2s!',mech:'freeze'},
cablechain:{emoji:'üîå',name:'Kabelsalat',ps:0,dm:1.4,rt:.55,col:'#FFEE58',
 desc:'Kettenblitz springt 4x!',mech:'chain'},
chair:{emoji:'ü™ë',name:'B√ºrostuhl',ps:220,dm:1.2,rt:.65,col:'#FFA726',
 desc:'Bumerang! Schubst Feinde ineinander!',mech:'boomkb'},
extinguish:{emoji:'üßØ',name:'Feuerl√∂scher',ps:240,dm:1.3,rt:.5,col:'#B0BEC5',
 desc:'CO2-Kegel: Pushback + Slow + AOE!',mech:'cone'},
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UPGRADES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const UPG=[
{t:'w',w:'stapler',emoji:'üìå',name:'Tacker-Salve',desc:'Rapid-Fire! Nagelt fest!',r:'common'},
{t:'w',w:'hotcoffee',emoji:'‚òï',name:'Hei√üer Kaffee',desc:'Splash + brennende Lache!',r:'common'},
{t:'w',w:'extinguish',emoji:'üßØ',name:'Feuerl√∂scher',desc:'CO2-Kegel: Push + Slow!',r:'rare'},
{t:'w',w:'coldcoffee',emoji:'üßä',name:'Kalter Kaffee',desc:'Slow ‚Üí EINFRIEREN!',r:'rare'},
{t:'w',w:'cablechain',emoji:'üîå',name:'Kabelsalat',desc:'Kettenblitz springt 4x!',r:'epic'},
{t:'w',w:'chair',emoji:'ü™ë',name:'B√ºrostuhl',desc:'Bumerang + Kollision!',r:'rare'},
{t:'s',k:'mhp',v:20,emoji:'‚ù§Ô∏è',name:'Betriebsarzt',desc:'+20 Max HP',r:'common'},
{t:'s',k:'mhp',v:40,emoji:'‚ù§Ô∏è‚Äçüî•',name:'Yoga-Kurs',desc:'+40 Max HP',r:'rare'},
{t:'s',k:'dmg',v:.12,emoji:'üí™',name:'Motivation',desc:'+12% Schaden',r:'common'},
{t:'s',k:'dmg',v:.25,emoji:'üî•',name:'Gehaltserh√∂hung',desc:'+25% Schaden',r:'rare'},
{t:'s',k:'spd',v:.12,emoji:'üëü',name:'Sneakers',desc:'+12% Speed',r:'common'},
{t:'s',k:'atk',v:.12,emoji:'‚è©',name:'3. Espresso',desc:'+12% Feuerrate',r:'common'},
{t:'s',k:'atk',v:.22,emoji:'‚ö°',name:'Energy Drink',desc:'+22% Feuerrate',r:'rare'},
{t:'s',k:'arm',v:3,emoji:'ü¶∫',name:'Schutzhelm',desc:'+3 R√ºstung',r:'common'},
{t:'s',k:'reg',v:1.5,emoji:'ü•ó',name:'Gesundes Essen',desc:'+1.5 HP/Sek',r:'rare'},
{t:'s',k:'mag',v:25,emoji:'üß≤',name:'Praktikant',desc:'Magnet+',r:'common'},
{t:'s',k:'crt',v:.08,emoji:'üí•',name:'Motivations-Push',desc:'+8% Krit',r:'rare'},
{t:'s',k:'prj',v:1,emoji:'üéÜ',name:'Beidh√§ndig',desc:'+1 Projektil!',r:'epic'},
{t:'i',id:'heal',emoji:'üíñ',name:'Wellness-Tag',desc:'Volle Heilung!',r:'common'},
{t:'i',id:'bomb',emoji:'üí£',name:'Feueralarm',desc:'T√∂tet alle Sichtbaren!',r:'epic'},
{t:'i',id:'coins',emoji:'üí∞',name:'Spesenkonto',desc:'+50 M√ºnzen',r:'rare'},
];

const SHOP=[
{id:'hp',name:'Fitness-Abo',emoji:'üèãÔ∏è',desc:'+10 HP',cost:30,max:10},
{id:'dmg',name:'Rhetorikkurs',emoji:'üé§',desc:'+5% DMG',cost:40,max:10},
{id:'spd',name:'Koffein',emoji:'‚òï',desc:'+5% Speed',cost:35,max:8},
{id:'armor',name:'Panzerung',emoji:'ü¶∫',desc:'+1 R√ºstung',cost:45,max:5},
{id:'luck',name:'Vitamin B',emoji:'ü§ù',desc:'Bessere Upgrades',cost:50,max:5},
{id:'xp',name:'Fortbildung',emoji:'üéì',desc:'+10% XP',cost:55,max:8},
];
const WNAMES=['08:00 ‚Äî Arbeitsbeginn!','09:00 ‚Äî Emails!','10:00 ‚Äî Meeting!','11:00 ‚Äî Kaffee leer!','12:00 ‚Äî Mittagschaos!','13:00 ‚Äî Food Coma!','14:00 ‚Äî Tief!','15:00 ‚Äî PPT-H√∂lle!','16:00 ‚Äî Deadline!','17:00 ‚Äî KEIN Feierabend!','18:00 ‚Äî √úberstunden!','19:00 ‚Äî Noch hier?!','20:00 ‚Äî Nachtschicht!','21:00 ‚Äî Wahnsinn!','22:00 ‚Äî APOKALYPSE!'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PARTICLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let parts=[];
function addP(x,y,vx,vy,l,c,s,tp){parts.push({x,y,vx,vy,life:l,ml:l,color:c,size:s,type:tp||'c',text:''})}
function burst(x,y,n,c,sp,sz,l){sp=sp||120;sz=sz||4;l=l||.5;for(let i=0;i<n;i++){const a=rng(0,PI2),s=rng(sp*.3,sp);addP(x,y,Math.cos(a)*s,Math.sin(a)*s,rng(l*.5,l),c,rng(sz*.5,sz))}}
function fTxt(x,y,t,c,s){s=s||16;parts.push({x,y,vx:rng(-15,15),vy:-55,life:1.2,ml:1.2,color:c||'#fff',size:s,type:'t',text:t})}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state='menu',P=null; // P = player
let enemies=[],projs=[],pickups=[],gfx=[]; // gfx = ground effects (puddles)
let gameTime=0,kills=0,coins=0,wave=1,waveT=0,spawnT=0;
let combo=0,comboT=0,lastMS=0,comboSpdB=0,comboShield=0;
let bossRef=null,specCD=0,worldW=3000,worldH=3000,menuA=0;
let cam={x:0,y:0,shake:0};
let inputDir={x:0,y:0},joyAct=false,joyS={x:0,y:0},joyId=null,keys={},taps=[],upChoices=[];
let runSaveTimer=0;
// Weapon state tracking
let wepState={clicks:0}; // for mouse multi-click
let hitTracker={}; // for pencil stacking

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INPUT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown',e=>{keys[e.key.toLowerCase()]=true;e.preventDefault()});
document.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false});
C.addEventListener('touchstart',e=>{e.preventDefault();initA();for(const t of e.changedTouches){const x=t.clientX,y=t.clientY;
if(state!=='playing'){taps.push({x,y});continue}
if(Math.hypot(x-(VW-55),y-(VH-100))<38){useSpec();continue}
if(x>VW-55&&y>VH-48){state='pause';saveRunNow();return}
if(x<VW*.45&&!joyAct){joyAct=true;joyS={x,y};joyId=t.identifier}
else taps.push({x,y})}},{passive:false});
C.addEventListener('touchmove',e=>{e.preventDefault();for(const t of e.changedTouches){if(t.identifier===joyId){
let dx=t.clientX-joyS.x,dy=t.clientY-joyS.y;const d=Math.hypot(dx,dy),m=55;
if(d>m){dx=dx/d*m;dy=dy/d*m}inputDir=d>8?{x:dx/m,y:dy/m}:{x:0,y:0}}}},{passive:false});
C.addEventListener('touchend',e=>{e.preventDefault();for(const t of e.changedTouches)if(t.identifier===joyId){joyAct=false;joyId=null;inputDir={x:0,y:0}}},{passive:false});
C.addEventListener('click',e=>{initA();if(state!=='playing')taps.push({x:e.clientX,y:e.clientY})});
addEventListener('beforeunload',()=>saveRunNow());
function getKI(){let dx=0,dy=0;if(keys.w||keys.arrowup)dy=-1;if(keys.s||keys.arrowdown)dy=1;if(keys.a||keys.arrowleft)dx=-1;if(keys.d||keys.arrowright)dx=1;
if(dx||dy){const l=Math.hypot(dx,dy);inputDir={x:dx/l,y:dy/l}}else if(!joyAct)inputDir={x:0,y:0};
if(keys[' ']){useSpec();keys[' ']=false}
if(keys.escape){
 if(state==='playing'){state='pause';saveRunNow()}
 else if(state==='pause')state='playing';
 keys.escape=false;
}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BUTTONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let btns=[];function btn(x,y,w,h,cb){btns.push({x:x-w/2,y:y-h/2,w,h,cb})}
function chkB(tp){for(const p of tp)for(const b of btns)if(p.x>=b.x&&p.x<=b.x+b.w&&p.y>=b.y&&p.y<=b.y+b.h){b.cb();sfx('coin');return true}return false}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DRAW HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dE(e,x,y,s){X.font=s+'px serif';X.textAlign='center';X.textBaseline='middle';X.fillText(e,x,y)}
function dT(t,x,y,s,c,a,st){X.font=`bold ${s}px 'Segoe UI',system-ui,sans-serif`;X.textAlign=a||'center';X.textBaseline='middle';
if(st){X.strokeStyle='#000';X.lineWidth=Math.max(2,s/4);X.strokeText(t,x,y)}X.fillStyle=c||'#fff';X.fillText(t,x,y)}
function dBar(x,y,w,h,p,c,bg){X.fillStyle=bg||'rgba(0,0,0,.5)';X.beginPath();X.roundRect(x,y,w,h,h/2);X.fill();
if(p>0){X.fillStyle=c;X.beginPath();X.roundRect(x,y,w*clamp(p,0,1),h,h/2);X.fill()}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGame(){
const ch=CHARS[selChar],su=save.up;
P={x:worldW/2,y:worldH/2,hp:ch.hp+su.hp*10,mhp:ch.hp+su.hp*10,
spd:ch.spd*(1+su.spd*.05),bdmg:ch.dmg*(1+su.dmg*.05),
dmgM:1,atkSpd:1,spdM:1,armor:su.armor,regen:ch.id===4?.5:0,
magnet:45,crit:.05,proj:0,xpM:1+su.xp*.1,
lv:1,xp:0,xpN:25,weps:[],ch,sz:15,invT:0,facing:{x:1,y:0},shieldT:0};
const wd=WP[ch.wep];P.weps.push({...wd,id:ch.wep,timer:0,lv:1,shotCount:0});
enemies=[];projs=[];pickups=[];parts=[];gfx=[];
gameTime=0;kills=0;coins=0;wave=1;waveT=0;spawnT=0;
combo=0;comboT=0;lastMS=0;comboSpdB=0;comboShield=0;
bossRef=null;specCD=0;upChoices=[];wepState={clicks:0};hitTracker={};
cam={x:P.x-VW/2,y:P.y-VH/2,shake:0};state='playing';runSaveTimer=0;
save.games++;save.run=null;doS();
}

function saveRunNow(){
if(!P||state==='menu'||state==='charsel'||state==='shop'||state==='stats'||state==='gameover')return;
save.run={
v:1,selChar,state:'pause',
gameTime,kills,coins,wave,waveT,spawnT,combo,comboT,lastMS,comboSpdB,comboShield,specCD,
P:{
x:P.x,y:P.y,hp:P.hp,mhp:P.mhp,spd:P.spd,bdmg:P.bdmg,dmgM:P.dmgM,atkSpd:P.atkSpd,spdM:P.spdM,armor:P.armor,regen:P.regen,
magnet:P.magnet,crit:P.crit,proj:P.proj,xpM:P.xpM,lv:P.lv,xp:P.xp,xpN:P.xpN,sz:P.sz,invT:P.invT,shieldT:P.shieldT,
facing:P.facing,chId:P.ch?.id||0,weps:(P.weps||[]).map(w=>({id:w.id,timer:w.timer||0,lv:w.lv||1,shotCount:w.shotCount||0}))
}
};
doS();
}

function clearRunSave(){
if(save.run!==null){save.run=null;doS()}
}

function restoreRunIfAny(){
const r=save.run;
if(!r||!r.P)return;
const chId=Number.isInteger(r.P.chId)?r.P.chId:0;
const ch=CHARS[chId]||CHARS[0];
selChar=Number.isInteger(r.selChar)?clamp(r.selChar,0,CHARS.length-1):ch.id;
P={x:r.P.x,y:r.P.y,hp:r.P.hp,mhp:r.P.mhp,spd:r.P.spd,bdmg:r.P.bdmg,dmgM:r.P.dmgM,atkSpd:r.P.atkSpd,spdM:r.P.spdM,armor:r.P.armor,regen:r.P.regen,
magnet:r.P.magnet,crit:r.P.crit,proj:r.P.proj,xpM:r.P.xpM,lv:r.P.lv,xp:r.P.xp,xpN:r.P.xpN,weps:[],ch,sz:r.P.sz||15,invT:r.P.invT||0,
facing:r.P.facing||{x:1,y:0},shieldT:r.P.shieldT||0};
P.weps=(r.P.weps||[]).map(w=>{if(!WP[w.id])return null;return {...WP[w.id],id:w.id,timer:w.timer||0,lv:w.lv||1,shotCount:w.shotCount||0}}).filter(Boolean);
if(!P.weps.length){const wd=WP[ch.wep];P.weps.push({...wd,id:ch.wep,timer:0,lv:1,shotCount:0})}
gameTime=r.gameTime||0;kills=r.kills||0;coins=r.coins||0;wave=Math.max(1,r.wave||1);waveT=r.waveT||0;spawnT=r.spawnT||0;
combo=r.combo||0;comboT=r.comboT||0;lastMS=r.lastMS||0;comboSpdB=r.comboSpdB||0;comboShield=r.comboShield||0;
specCD=r.specCD||0;bossRef=null;upChoices=[];wepState={clicks:0};hitTracker={};enemies=[];projs=[];pickups=[];parts=[];gfx=[];
cam={x:P.x-VW/2,y:P.y-VH/2,shake:0};state='pause';runSaveTimer=0;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMBO LOGIC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addCombo(){
combo++;comboT=2.5;
// Check milestones
for(const m of COMBO_M){
 if(combo===m.at){
  sfx('combo');fTxt(P.x,P.y-40,m.name,m.col,clamp(18+combo*.2,18,40));
  burst(P.x,P.y,15+combo*.3,m.col,100+combo,5,.5);
  coins+=m.co;
  if(m.heal>0)P.hp=Math.min(P.mhp,P.hp+P.mhp*m.heal);
  // Damage pulse ‚Äî hurts all nearby enemies
  if(m.pulse>0){
   sfx('boom');cam.shake=Math.min(15,5+combo*.1);
   for(const e of enemies){if(e.hp>0&&dst(P,e)<m.pulse)hurtE(e,Math.floor(P.bdmg*P.dmgM*(1+combo*.03)),true)}
   burst(P.x,P.y,20,m.col,m.pulse,6,.4);
  }
  // Shield at 50+
  if(combo>=50)comboShield=3;
  // Speed boost at 35+
  if(combo>=35)comboSpdB=4;
  // Track best
  if(combo>save.bestCombo){save.bestCombo=combo;doS()}
  lastMS=combo;
 }
}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SPAWNING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnE(){
if(!P)return;const a=rng(0,PI2),d=Math.max(VW,VH)*.55+rng(30,120);
const sx=P.x+Math.cos(a)*d,sy=P.y+Math.sin(a)*d;
const mx=Math.min(2+Math.floor(wave*0.7),ET.length); // unlocks types FASTER
const et=ET[rngI(0,mx-1)];
const sc=1+wave*.18; // HP scales 18% per wave (was 12%)
const spdSc=1+wave*.04; // Speed also scales!
const dmgSc=1+wave*.1; // DMG scales 10% per wave
// ELITE chance: 15% from wave 3, 30% from wave 7
const isElite=wave>=3&&Math.random()<(wave>=7?.3:.15);
const em=isElite?2.5:1, esm=isElite?1.3:1, edm=isElite?1.5:1;
enemies.push({...et,x:sx,y:sy,
hp:Math.floor(et.hp*sc*em),mhp:Math.floor(et.hp*sc*em),
spd:et.spd*spdSc*esm,dmg:Math.floor(et.dmg*dmgSc*edm),
xp:Math.floor(et.xp*(1+wave*.05)*(isElite?2:1)),
co:et.co*(isElite?3:1),flash:0,slowT:0,freezeT:0,pinT:0,
atkT:0,isBoss:false,elite:isElite,infected:false,
chargeT:0,chargeCD:0,uid:Math.random()
});
}

function spawnBoss(){
if(bossRef||!P)return;const bi=clamp(Math.floor((wave-5)/5),0,BT.length-1);
const bt={...BT[bi]},sc=1+wave*.22;
bt.hp=Math.floor(bt.hp*sc);bt.mhp=bt.hp;bt.dmg=Math.floor(bt.dmg*(1+wave*.1));
bt.xp=Math.floor(bt.xp*(1+wave*.08));
const a=rng(0,PI2);bt.x=P.x+Math.cos(a)*350;bt.y=P.y+Math.sin(a)*350;
bt.flash=0;bt.slowT=0;bt.freezeT=0;bt.pinT=0;bt.atkT=0;bt.isBoss=true;
bt.elite=false;bt.infected=false;bt.chargeT=0;bt.chargeCD=0;bt.uid=Math.random();
bossRef=bt;enemies.push(bt);sfx('boss');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIRE WEAPONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fireW(w){
if(!P)return;
const cdmg=comboDmg(); // combo passive DMG
const dmg=Math.floor(w.dm*P.bdmg*P.dmgM*cdmg);
const shots=1+P.proj;
let near=null,nd=450;
for(const e of enemies){if(e.hp<=0)continue;const d=dst(P,e);if(d<nd){nd=d;near=e}}

w.shotCount=(w.shotCount||0)+1;

// === CHAIN LIGHTNING (Kabelsalat) ===
if(w.mech==='chain'){
 if(!near)return;sfx('shoot');
 let tgt=near,ch=[tgt];hurtE(tgt,dmg);
 for(let c=0;c<4;c++){let nt=null,nd2=160;
  for(const e of enemies){if(ch.includes(e)||e.hp<=0)continue;const d2=dst(tgt,e);if(d2<nd2){nd2=d2;nt=e}}
  if(!nt)break;
  for(let j=0;j<6;j++){const t2=j/6;addP(lerp(tgt.x,nt.x,t2)+rng(-10,10),lerp(tgt.y,nt.y,t2)+rng(-10,10),0,0,.12,w.col,3)}
  hurtE(nt,Math.floor(dmg*.8));ch.push(nt);tgt=nt}
 return;
}

// === CONE (Feuerl√∂scher) ===
if(w.mech==='cone'){
 if(!near)return;sfx('shoot');
 const fa=ang(P,near);
 for(const e of enemies){if(e.hp<=0)continue;const d2=dst(P,e),ea=ang(P,e);
  let ad=Math.abs(ea-fa);if(ad>PI)ad=PI2-ad;
  if(d2<160&&ad<.5){hurtE(e,dmg);e.slowT=Math.max(e.slowT,1.5);
   const ka=ang(P,e);e.x+=Math.cos(ka)*55;e.y+=Math.sin(ka)*55}}
 // Visual cone
 for(let i=0;i<12;i++){const ca=fa+rng(-.5,.5),cd=rng(30,140);
  addP(P.x+Math.cos(ca)*cd,P.y+Math.sin(ca)*cd,Math.cos(ca)*40,Math.sin(ca)*40,.3,w.col,rng(3,6))}
 return;
}

if(!near)return;sfx('shoot');

for(let s=0;s<shots;s++){
 const spread=(s-(shots-1)/2)*.2;
 const a=ang(P,near)+spread;
 const pr={x:P.x,y:P.y,vx:Math.cos(a)*(w.ps||300),vy:Math.sin(a)*(w.ps||300),
  dmg,col:w.col,sz:5,life:1.5,own:'p',mech:w.mech,wid:w.id,
  pierce:0,retT:0,aoe:0,sc:w.shotCount};

 // Weapon-specific projectile properties
 switch(w.mech){
  case'multi': // Mouse: every 4th = 3x + aoe
   if(w.shotCount%4===0){pr.dmg=dmg*3;pr.aoe=50;pr.sz=8}break;
  case'grease':pr.aoe=35;break; // Schnitzel
  case'wetfloor':pr.aoe=25;break; // Mopp
  case'infect':break; // Spritze
  case'goldrush':pr.pierce=99;break; // Kreditkarte pierces all
  case'pin':break; // Tacker
  case'burn':pr.aoe=40;break; // Hei√üer Kaffee
  case'freeze':break; // Kalter Kaffee
  case'boomkb':pr.pierce=5;pr.retT=0;break; // B√ºrostuhl boomerang
 }
 projs.push(pr);
}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HURT ENEMY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function hurtE(e,dmg,noCrit){
if(!e||e.hp<=0||!P)return;
let cr=!noCrit&&Math.random()<P.crit,fd=cr?dmg*2:dmg;
// Frozen enemies take 2x damage!
if(e.freezeT>0)fd=Math.floor(fd*2);
e.hp-=fd;e.flash=.12;
fTxt(e.x,e.y-e.sz,(cr?'KRIT!':'')+fd,cr?'#FF5722':e.freezeT>0?'#00E5FF':'#FFD740',cr?20:15);
burst(e.x,e.y,2,e.elite?'#FFD700':'#fff',50,3,.15);sfx('hit');
if(e.hp<=0)killE(e);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ON-HIT EFFECTS (Weapon Mechanics) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onHit(pr,e){
if(!P)return;
switch(pr.mech){
 case'stack':{ // Bleistift: 3 hits on same = burst
  const uid=''+e.uid;hitTracker[uid]=(hitTracker[uid]||0)+1;
  if(hitTracker[uid]>=3){hitTracker[uid]=0;hurtE(e,pr.dmg*2.5,true);
   fTxt(e.x,e.y-25,'üìù NOTIZ!','#FFD54F',18);burst(e.x,e.y,8,'#FFD54F',80,4,.3);sfx('boom')}
  break;}
 case'grease':{ // Schnitzel: grease puddle
  gfx.push({x:e.x,y:e.y,r:35,dps:12,dur:3,slow:.35,col:'#E65100',t:0});
  e.slowT=Math.max(e.slowT,.8);break;}
 case'wetfloor':{ // Mopp: knockback + wet floor
  const ka=ang(P,e);e.x+=Math.cos(ka)*35;e.y+=Math.sin(ka)*35;
  gfx.push({x:e.x,y:e.y,r:28,dps:3,dur:4,slow:.3,col:'#64B5F6',t:0});break;}
 case'infect':{ // Spritze: infect enemy
  e.infected=true;break;}
 case'goldrush':{ // Kreditkarte: coin drop on hit
  if(Math.random()<.25){pickups.push({x:e.x+rng(-8,8),y:e.y+rng(-8,8),type:'coin',val:1,life:12});sfx('coin')}
  break;}
 case'pin':{ // Tacker: pin in place
  e.pinT=Math.max(e.pinT,.5);break;}
 case'burn':{ // Hei√üer Kaffee: burning puddle
  gfx.push({x:e.x,y:e.y,r:30,dps:18,dur:2.5,slow:.65,col:'#4E342E',t:0});break;}
 case'freeze':{ // Kalter Kaffee: slow ‚Üí double hit = freeze
  if(e.slowT>0){e.freezeT=2;e.slowT=0;fTxt(e.x,e.y-20,'‚ùÑÔ∏è FROZEN!','#00E5FF',16);
   burst(e.x,e.y,8,'#29B6F6',60,4,.3);sfx('freeze')}
  else e.slowT=Math.max(e.slowT,1.5);break;}
 case'boomkb':{ // B√ºrostuhl: knockback into others
  const ka=ang(P,e);e.x+=Math.cos(ka)*45;e.y+=Math.sin(ka)*45;
  // Check if knocked into another enemy
  for(const e2 of enemies){if(e2===e||e2.hp<=0)continue;
   if(dst(e,e2)<e.sz+e2.sz+10){hurtE(e2,Math.floor(pr.dmg*.6),true);
    fTxt(e2.x,e2.y-15,'üí•CRASH!','#FFA726',14);burst(e2.x,e2.y,4,'#FFA726',50,3,.2)}}
  break;}
}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê KILL ENEMY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function killE(e){
if(!P)return;e.hp=0;kills++;addCombo();
const cxp=comboXp(); // combo passive XP bonus
pickups.push({x:e.x,y:e.y,type:'xp',val:Math.floor(e.xp*P.xpM*cxp),life:15});
if(Math.random()<.3)pickups.push({x:e.x+rng(-10,10),y:e.y+rng(-10,10),type:'coin',val:e.co||1,life:15});
if(Math.random()<.03)pickups.push({x:e.x,y:e.y,type:'hp',val:Math.floor(P.mhp*.1),life:15});
burst(e.x,e.y,e.elite?15:8,e.elite?'#FFD700':'#aaa',100,5,.4);sfx('kill');

// INFECT chain explosion!
if(e.infected){
 sfx('boom');burst(e.x,e.y,12,'#F48FB1',120,6,.4);
 for(const e2 of enemies){if(e2===e||e2.hp<=0)continue;
  if(dst(e,e2)<80){hurtE(e2,Math.floor(P.bdmg*P.dmgM*1.5),true);e2.infected=true}}
}

if(e.isBoss){bossRef=null;burst(e.x,e.y,30,'#FFD700',180,8,.7);sfx('boom');cam.shake=15;
 for(let i=0;i<10;i++)pickups.push({x:e.x+rng(-50,50),y:e.y+rng(-50,50),type:'coin',val:Math.floor(e.co/10),life:15})}
// Clean hitTracker
delete hitTracker[''+e.uid];
}

function pHurt(d){
if(!P||P.invT>0||P.shieldT>0||comboShield>0)return;
const fd=Math.max(1,d-P.armor);P.hp-=fd;P.invT=.4;
fTxt(P.x,P.y-20,'-'+fd,'#FF1744',18);burst(P.x,P.y,5,'#FF1744',80,4,.3);
sfx('hurt');cam.shake=5;
// Combo broken by damage!
if(combo>=5){fTxt(P.x,P.y-40,'COMBO LOST!','#FF5252',14);combo=0;comboT=0;lastMS=0}
if(P.hp<=0){P.hp=0;gameOver()}
}

function addXP(v){if(!P)return;P.xp+=v;while(P.xp>=P.xpN){P.xp-=P.xpN;P.lv++;
P.xpN=Math.floor(P.xpN*1.28+15);sfx('lvl');burst(P.x,P.y,18,'#FFD740',120,5,.5);
state='upgrade';makeUC();saveRunNow()}}

function comboDmg(){return 1+Math.min(combo*.015,1)} // +1.5% per combo, max +100%
function comboXp(){return 1+Math.min(combo*.012,0.8)} // +1.2% per combo, max +80%
function comboSpd(){return comboSpdB>0?.25:Math.min(combo*.008,.3)} // max +30%

function useSpec(){
if(!P||state!=='playing'||specCD>0)return;
const ch=P.ch;specCD=ch.sCD;sfx('power');
switch(ch.spec){
 case'coffee':P.hp=Math.min(P.mhp,P.hp+Math.floor(P.mhp*.25));fTxt(P.x,P.y-30,'‚òï KAFFEE!','#4CAF50',22);burst(P.x,P.y,12,'#795548',80,4,.4);break;
 case'reboot':P.hp=Math.min(P.mhp,P.hp+20);burst(P.x,P.y,15,'#2196F3',150,6,.5);
  enemies.forEach(e=>{if(e.hp>0&&dst(P,e)<130)hurtE(e,Math.floor(P.bdmg*3))});break;
 case'soup':burst(P.x,P.y,20,'#FF9800',120,5,.5);
  enemies.forEach(e=>{if(e.hp>0&&dst(P,e)<160)hurtE(e,Math.floor(P.bdmg*2))});
  gfx.push({x:P.x,y:P.y,r:100,dps:15,dur:4,slow:.5,col:'#E65100',t:0});break;
 case'sweep':enemies.forEach(e=>{if(e.hp>0&&dst(P,e)<180){const a=ang(P,e);e.x+=Math.cos(a)*90;e.y+=Math.sin(a)*90;hurtE(e,Math.floor(P.bdmg*1.5))}});
  gfx.push({x:P.x,y:P.y,r:80,dps:5,dur:5,slow:.4,col:'#64B5F6',t:0});burst(P.x,P.y,15,'#9C27B0',130,5,.5);break;
 case'immune':P.shieldT=5;burst(P.x,P.y,12,'#E91E63',80,4,.4);fTxt(P.x,P.y-30,'üìã KRANK!','#E91E63',18);break;
 case'nuke':enemies.forEach(e=>{if(e.hp>0)hurtE(e,Math.floor(P.bdmg*5))});burst(P.x,P.y,30,'#FFD700',200,8,.7);cam.shake=15;sfx('boom');fTxt(P.x,P.y-30,'üí∏ GEFEUERT!','#FFD700',22);break;
}}

function gameOver(){state='gameover';save.totalKills+=kills;save.coins+=coins;
if(gameTime>save.bestTime)save.bestTime=gameTime;if(wave>save.bestWave)save.bestWave=wave;
if(kills>save.bestKills)save.bestKills=kills;if(combo>save.bestCombo)save.bestCombo=combo;clearRunSave();doS();sfx('boom')}

function makeUC(){if(!P)return;let pool=UPG.filter(u=>{if(u.t==='w')return!P.weps.find(w=>w.id===u.w);return true});
const lk=save.up.luck*.04;upChoices=[];
for(let i=0;i<3;i++){if(!pool.length)break;let f=pool;if(Math.random()<.25+lk)f=pool.filter(u=>u.r!=='common');
if(!f.length)f=pool;const idx=rngI(0,f.length-1);upChoices.push(f[idx]);pool=pool.filter(u=>u!==f[idx])}}

function pickUP(u){sfx('power');
if(u.t==='w'){const wd={...WP[u.w]};wd.id=u.w;wd.timer=0;wd.lv=1;wd.shotCount=0;P.weps.push(wd)}
else if(u.t==='s'){
 if(u.k==='mhp'){P.mhp+=u.v;P.hp=Math.min(P.mhp,P.hp+u.v)}
 else if(u.k==='dmg')P.dmgM+=u.v;else if(u.k==='spd')P.spdM+=u.v;
 else if(u.k==='atk')P.atkSpd+=u.v;else if(u.k==='arm')P.armor+=u.v;
 else if(u.k==='reg')P.regen+=u.v;else if(u.k==='mag')P.magnet+=u.v;
 else if(u.k==='crt')P.crit+=u.v;else if(u.k==='prj')P.proj+=u.v;
}else if(u.t==='i'){
 if(u.id==='heal')P.hp=P.mhp;
 else if(u.id==='bomb'){enemies.forEach(e=>{if(!e.isBoss&&e.hp>0)killE(e)});enemies=enemies.filter(e=>e.hp>0);sfx('boom');cam.shake=12}
 else if(u.id==='coins')coins+=50;
}
state='playing';upChoices=[]}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üîÑ UPDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function update(dt){
if(state!=='playing'||!P)return;
gameTime+=dt;getKI();

// Movement (with combo speed bonus)
const spd=P.spd*P.spdM*(1+comboSpd());
P.x+=inputDir.x*spd*dt;P.y+=inputDir.y*spd*dt;
P.x=clamp(P.x,20,worldW-20);P.y=clamp(P.y,20,worldH-20);
if(inputDir.x||inputDir.y)P.facing={x:inputDir.x,y:inputDir.y};

if(P.invT>0)P.invT-=dt;
if(P.shieldT>0)P.shieldT-=dt;
if(comboShield>0)comboShield-=dt;
if(comboSpdB>0)comboSpdB-=dt;
if(specCD>0)specCD-=dt;
if(P.regen>0)P.hp=Math.min(P.mhp,P.hp+P.regen*dt);

// Combo timer
if(comboT>0){comboT-=dt;if(comboT<=0){combo=0;lastMS=0}}

// Waves ‚Äî 25s per wave (faster!)
waveT+=dt;if(waveT>=25){waveT=0;wave++;sfx('lvl');if(wave%5===0)spawnBoss()}

// Spawn ‚Äî MUCH faster spawning!
const sr=Math.max(.12,1.4-wave*.12); // Gets fast quick!
spawnT+=dt;
if(spawnT>=sr&&enemies.length<50+wave*5){spawnT=0;
 const cnt=Math.min(1+Math.floor(wave*.5),6); // More enemies per spawn
 for(let i=0;i<cnt;i++)spawnE()}

// Fire weapons
P.weps.forEach(w=>{w.timer=(w.timer||0)-dt;
 if(w.timer<=0){w.timer=(w.rt||.4)/(1+P.atkSpd*.3);fireW(w)}});

// Projectiles
for(let i=projs.length-1;i>=0;i--){
 const p=projs[i];
 // Boomerang return
 if(p.mech==='boomkb'){p.retT+=dt;if(p.retT>.4){const a=ang(p,P);p.vx=Math.cos(a)*350;p.vy=Math.sin(a)*350;
  if(dst(p,P)<25){projs.splice(i,1);continue}}}
 p.x+=p.vx*dt;p.y+=p.vy*dt;p.life-=dt;
 if(p.life<=0){projs.splice(i,1);continue}
 if(p.own==='p'){let rm=false;
  for(let j=enemies.length-1;j>=0;j--){const e=enemies[j];if(e.hp<=0)continue;
   if(dst(p,e)<e.sz+p.sz){
    hurtE(e,p.dmg);onHit(p,e); // Apply weapon mechanic!
    // AOE damage
    if(p.aoe>0){for(const e2 of enemies){if(e2!==e&&e2.hp>0&&dst(p,e2)<p.aoe)hurtE(e2,Math.floor(p.dmg*.5),true)}
     burst(p.x,p.y,6,p.col,p.aoe,4,.3)}
    if(p.pierce>0){p.pierce--;p.dmg=Math.floor(p.dmg*.85)}
    else if(p.mech!=='boomkb'){projs.splice(i,1);rm=true;break}}}
  if(rm)continue;
 }else{if(dst(p,P)<P.sz+p.sz){pHurt(p.dmg);projs.splice(i,1)}}
}

// Ground effects (puddles)
for(let i=gfx.length-1;i>=0;i--){
 const g=gfx[i];g.t+=dt;if(g.t>=g.dur){gfx.splice(i,1);continue}
 // Damage & slow enemies in puddle
 for(const e of enemies){if(e.hp<=0)continue;
  if(dst({x:g.x,y:g.y},e)<g.r+e.sz){
   if(Math.random()<dt*3)hurtE(e,Math.ceil(g.dps*dt*3),true);
   e.slowT=Math.max(e.slowT,.3)}}}

// Enemies
for(let i=enemies.length-1;i>=0;i--){
 const e=enemies[i];if(e.hp<=0){enemies.splice(i,1);continue}
 if(e.flash>0)e.flash-=dt;

 // Movement (with freeze/pin/slow)
 let ms=e.spd;
 if(e.freezeT>0){ms=0;e.freezeT-=dt;} // Frozen = can't move
 else if(e.pinT>0){ms=0;e.pinT-=dt;} // Pinned = can't move
 else if(e.slowT>0){ms*=.3;e.slowT-=dt;} // Slowed

 const ea=ang(e,P),ed=dst(e,P);

 // Charge attack (Deadline, W√ºtender Kunde)
 if(e.charge&&!e.isBoss){
  e.chargeCD=(e.chargeCD||0)+dt;
  if(e.chargeCD>3&&ed<250&&ed>60&&ms>0){
   e.chargeT=.4;e.chargeCD=0;e.chA=ea; // Lock angle and sprint
   fTxt(e.x,e.y-e.sz-5,'‚ö°','#FF5252',14)}
  if(e.chargeT>0){e.chargeT-=dt;ms=e.spd*4;const ca=e.chA||ea;
   e.x+=Math.cos(ca)*ms*dt;e.y+=Math.sin(ca)*ms*dt}
  else{e.x+=Math.cos(ea)*ms*dt;e.y+=Math.sin(ea)*ms*dt}
 }else if(ms>0){e.x+=Math.cos(ea)*ms*dt;e.y+=Math.sin(ea)*ms*dt}

 // Contact damage
 if(ed<P.sz+e.sz)pHurt(e.dmg);

 // Ranged (Drucker)
 if(e.ranged&&ms>0){e.atkT=(e.atkT||0)+dt;if(e.atkT>1.2){e.atkT=0;
  projs.push({x:e.x,y:e.y,vx:Math.cos(ea)*200,vy:Math.sin(ea)*200,dmg:e.dmg,col:'#fff',sz:4,life:2,own:'e',mech:'',pierce:0,aoe:0})}}

 // Aura (PPT, Zoom)
 if(e.aura&&ed<e.aura&&ms>0)pHurt(Math.ceil(e.dmg*.4*dt));

 // Boss attacks ‚Äî MORE aggressive!
 if(e.isBoss){e.atkT=(e.atkT||0)+dt;
  if(e.atkT>1.5){e.atkT=0; // Attack every 1.5s (was 2s)
   const r=Math.random();
   if(r<.35){// Burst shot
    for(let f=0;f<8;f++){const fa=f*(PI2/8);
     projs.push({x:e.x,y:e.y,vx:Math.cos(fa)*200,vy:Math.sin(fa)*200,dmg:e.dmg,col:'#FF5722',sz:6,life:2,own:'e',mech:'',pierce:0,aoe:0})}sfx('boom')}
   else if(r<.55){// Spawn minions
    for(let s=0;s<4+Math.floor(wave*.3);s++)spawnE()}
   else if(r<.75){// Charge at player
    e.chargeT=.6;e.chA=ea;e.charge=true;sfx('boss')}
   else{// Aimed triple shot
    for(let f=-1;f<=1;f++){const fa=ea+f*.3;
     projs.push({x:e.x,y:e.y,vx:Math.cos(fa)*250,vy:Math.sin(fa)*250,dmg:Math.floor(e.dmg*1.2),col:'#FF1744',sz:7,life:2,own:'e',mech:'',pierce:0,aoe:0})}
   }
  }
 }
}

// Pickups
for(let i=pickups.length-1;i>=0;i--){
 const p=pickups[i];p.life-=dt;if(p.life<=0){pickups.splice(i,1);continue}
 const d=dst(p,P);
 if(d<P.magnet){const a=ang(p,P),s=Math.max(250,500-d*3);p.x+=Math.cos(a)*s*dt;p.y+=Math.sin(a)*s*dt}
 if(d<22){
  if(p.type==='xp'){addXP(p.val);sfx('xp')}
  else if(p.type==='coin'){coins+=p.val;sfx('coin')}
  else if(p.type==='hp'){P.hp=Math.min(P.mhp,P.hp+p.val);fTxt(P.x,P.y-20,'+'+p.val,'#4CAF50',16);sfx('xp')}
  pickups.splice(i,1)}}

// Particles
for(let i=parts.length-1;i>=0;i--){const p=parts[i];
 p.x+=p.vx*dt;p.y+=p.vy*dt;if(p.type==='c')p.vy+=200*dt;p.vx*=.97;p.life-=dt;
 if(p.life<=0)parts.splice(i,1)}

cam.x=lerp(cam.x,P.x-VW/2,6*dt);cam.y=lerp(cam.y,P.y-VH/2,6*dt);
if(cam.shake>.5)cam.shake*=.88;else cam.shake=0;
runSaveTimer+=dt;
if(runSaveTimer>=1){runSaveTimer=0;saveRunNow()}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üé® RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
X.clearRect(0,0,VW,VH);
if(state==='menu'){rMenu();return}if(state==='charsel'){rCharSel();return}
if(state==='shop'){rShop();return}if(state==='stats'){rStats();return}
if(!P)return;rGame();
if(state==='upgrade')rUpg();if(state==='pause')rPause();if(state==='gameover')rGO();
}

function rGame(){
const cx=cam.x+(cam.shake>0?rng(-cam.shake,cam.shake):0);
const cy=cam.y+(cam.shake>0?rng(-cam.shake,cam.shake):0);

// BG
const bg=X.createRadialGradient(VW/2,VH/2,50,VW/2,VH/2,VW*.7);
bg.addColorStop(0,'#1c1c3a');bg.addColorStop(1,'#0a0a18');X.fillStyle=bg;X.fillRect(0,0,VW,VH);

// Grid
const gs=80;X.strokeStyle='rgba(80,80,140,.06)';X.lineWidth=1;
for(let gx=-(cx%gs);gx<VW+gs;gx+=gs){X.beginPath();X.moveTo(gx,0);X.lineTo(gx,VH);X.stroke()}
for(let gy=-(cy%gs);gy<VH+gs;gy+=gs){X.beginPath();X.moveTo(0,gy);X.lineTo(VW,gy);X.stroke()}

// Ground FX (puddles)
gfx.forEach(g=>{const sx=g.x-cx,sy=g.y-cy,a=1-g.t/g.dur;
 X.globalAlpha=a*.35;X.fillStyle=g.col;X.beginPath();X.arc(sx,sy,g.r,0,PI2);X.fill();
 X.globalAlpha=a*.15;X.fillStyle='#fff';X.beginPath();X.arc(sx,sy,g.r*.4,0,PI2);X.fill();
 X.globalAlpha=1});

// Pickups
pickups.forEach(p=>{const sx=p.x-cx,sy=p.y-cy,b=Math.sin(gameTime*5+p.x)*3;
 if(p.type==='xp')dE('‚≠ê',sx,sy+b,14);else if(p.type==='coin')dE('ü™ô',sx,sy+b,14);
 else dE('üíö',sx,sy+b,14)});

// Enemies
enemies.forEach(e=>{if(e.hp<=0)return;const sx=e.x-cx,sy=e.y-cy;
 X.fillStyle='rgba(0,0,0,.2)';X.beginPath();X.ellipse(sx,sy+e.sz*.6,e.sz*.7,e.sz*.25,0,0,PI2);X.fill();
 // Elite glow
 if(e.elite){X.globalAlpha=.2+Math.sin(gameTime*6)*.1;X.fillStyle='#FFD700';X.beginPath();X.arc(sx,sy,e.sz+6,0,PI2);X.fill();X.globalAlpha=1}
 // Freeze visual
 if(e.freezeT>0){X.fillStyle='rgba(0,200,255,.3)';X.beginPath();X.arc(sx,sy,e.sz+4,0,PI2);X.fill()}
 // Pin visual
 if(e.pinT>0){X.fillStyle='rgba(255,50,50,.25)';X.beginPath();X.arc(sx,sy,e.sz+3,0,PI2);X.fill()}
 // Body
 X.fillStyle=e.flash>.01?'#fff':e.freezeT>0?'#88EEFF':e.slowT>0?'#88ccff':'#3a3a5a';
 X.beginPath();X.arc(sx,sy,e.sz,0,PI2);X.fill();
 X.strokeStyle=e.elite?'#FFD700':'rgba(255,255,255,.08)';X.lineWidth=e.elite?2:1;X.stroke();
 dE(e.emoji,sx,sy,e.sz*1.3);
 // Infected marker
 if(e.infected){X.globalAlpha=.5+Math.sin(gameTime*8)*.3;dE('‚ò£Ô∏è',sx-e.sz*.7,sy-e.sz*.7,10);X.globalAlpha=1}
 // HP bar
 if(e.hp<e.mhp){const bw=e.sz*2;dBar(sx-bw/2,sy-e.sz-9,bw,4,e.hp/e.mhp,e.isBoss?'#FF5252':'#66BB6A')}
 if(e.isBoss)dE('üëë',sx,sy-e.sz-16,18);
 // Aura
 if(e.aura){X.globalAlpha=.06+Math.sin(gameTime*3)*.03;X.fillStyle='#FF5722';X.beginPath();X.arc(sx,sy,e.aura,0,PI2);X.fill();X.globalAlpha=1}
});

// Projectiles
projs.forEach(p=>{const sx=p.x-cx,sy=p.y-cy;
 X.fillStyle=p.col||'#fff';X.beginPath();X.arc(sx,sy,p.sz,0,PI2);X.fill();
 X.strokeStyle=(p.col||'#fff')+'88';X.lineWidth=p.sz*.6;
 X.beginPath();X.moveTo(sx,sy);X.lineTo(sx-p.vx*.015,sy-p.vy*.015);X.stroke()});

// Particles
parts.forEach(p=>{const sx=p.x-cx,sy=p.y-cy,a=clamp(p.life/p.ml,0,1);
 X.globalAlpha=a;
 if(p.type==='t')dT(p.text,sx,sy,p.size,p.color,'center',true);
 else{X.fillStyle=p.color;X.beginPath();X.arc(sx,sy,p.size*a,0,PI2);X.fill()}
 X.globalAlpha=1});

// Player
if(P.hp>0){const px=P.x-cx,py=P.y-cy;
 X.fillStyle='rgba(0,0,0,.25)';X.beginPath();X.ellipse(px,py+P.sz*.7,P.sz*.7,P.sz*.25,0,0,PI2);X.fill();
 // Shield/Combo shield
 if(P.shieldT>0||comboShield>0){
  const sc=P.shieldT>0?'rgba(233,30,99':'rgba(0,229,255';
  X.strokeStyle=sc+`,${.4+Math.sin(gameTime*8)*.2})`;X.lineWidth=3;
  X.beginPath();X.arc(px,py,P.sz+10,0,PI2);X.stroke()}
 const blink=P.invT>0&&Math.floor(P.invT*10)%2===0;
 if(!blink){X.fillStyle=P.ch.color;X.beginPath();X.arc(px,py,P.sz,0,PI2);X.fill();
  X.strokeStyle='rgba(255,255,255,.3)';X.lineWidth=2;X.stroke();
  dE(P.ch.emoji,px,py,P.sz*1.6)}}

rHUD();
}

function rHUD(){
if(!P)return;
// HP
dBar(12,12,clamp(VW*.28,80,180),14,P.hp/P.mhp,'#EF5350','rgba(0,0,0,.5)');
dT(`${Math.ceil(P.hp)}/${P.mhp}`,12+clamp(VW*.14,40,90),19,9,'#fff','center',true);
// XP
dBar(12,VH-18,VW-24,8,P.xp/P.xpN,'#42A5F5','rgba(0,0,0,.4)');
// Level
X.fillStyle='rgba(255,215,0,.15)';X.beginPath();X.roundRect(VW/2-35,8,70,22,11);X.fill();
dT('LV '+P.lv,VW/2,19,12,'#FFD740');
// Wave name
const wn=WNAMES[Math.min(wave-1,WNAMES.length-1)]||('Welle '+wave);
dT('‚è± '+fmtT(gameTime),12,38,11,'rgba(255,255,255,.6)','left',true);
dT('üåä '+wn,VW/2,38,9,'rgba(255,200,100,.6)','center',true);
dT('üíÄ '+kills,VW-12,15,14,'#fff','right',true);
dT('ü™ô '+coins,VW-12,35,12,'#FFD740','right',true);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMBO DISPLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if(combo>=3){
 const ms=COMBO_M.filter(m=>m.at<=combo);
 const curMS=ms.length>0?ms[ms.length-1]:null;
 const col=curMS?curMS.col:'#FFD740';
 const sz=clamp(14+combo*.25,14,40);
 const nextMS=COMBO_M.find(m=>m.at>combo);

 // Combo counter
 dT(combo+'x',VW-12,VH*.28,sz,col,'right',true);
 // Current milestone name
 if(curMS)dT(curMS.name,VW-12,VH*.28+sz*.7,11,col,'right',true);
 // Next milestone progress
 if(nextMS){const prev=curMS?curMS.at:0;const pct=(combo-prev)/(nextMS.at-prev);
  dBar(VW-120,VH*.28+sz*.7+12,108,5,pct,col,'rgba(0,0,0,.3)');
  dT('‚Üí '+nextMS.at+'x: '+nextMS.name,VW-12,VH*.28+sz*.7+26,8,'rgba(255,255,255,.4)','right')}
 // Passive bonus display
 const dmgB=Math.floor((comboDmg()-1)*100),spdB=Math.floor(comboSpd()*100);
 if(dmgB>0)dT('+'+dmgB+'% DMG',VW-12,VH*.28+sz*.7+38,8,'rgba(255,200,100,.5)','right');
 if(spdB>0)dT('+'+spdB+'% SPD',VW-12,VH*.28+sz*.7+50,8,'rgba(100,200,255,.5)','right');
}

// Weapon icons
P.weps.forEach((w,i)=>{const wx=14+i*38,wy=VH-42;
 X.fillStyle='rgba(0,0,0,.4)';X.beginPath();X.roundRect(wx,wy,32,28,6);X.fill();
 X.strokeStyle='rgba(255,255,255,.15)';X.lineWidth=1;X.stroke();
 dE(WP[w.id]?.emoji||'?',wx+16,wy+14,15)});

// Joystick
const jx=75,jy=VH-110;
X.fillStyle='rgba(255,255,255,.05)';X.beginPath();X.arc(jx,jy,55,0,PI2);X.fill();
X.strokeStyle='rgba(255,255,255,.1)';X.lineWidth=2;X.stroke();
X.fillStyle='rgba(255,255,255,.18)';X.beginPath();X.arc(jx+inputDir.x*40,jy+inputDir.y*40,22,0,PI2);X.fill();

// Special
const bx=VW-55,by=VH-100,br=32,rdy=specCD<=0;
X.fillStyle=rdy?'rgba(255,152,0,.35)':'rgba(100,100,100,.25)';
X.beginPath();X.arc(bx,by,br,0,PI2);X.fill();
X.strokeStyle=rdy?'#FFA726':'#555';X.lineWidth=2;X.stroke();
if(!rdy){X.strokeStyle='#FFA726';X.lineWidth=3;X.beginPath();X.arc(bx,by,br,-PI/2,-PI/2+(1-specCD/P.ch.sCD)*PI2);X.stroke()}
dE('üí•',bx,by,22);dT(rdy?'BEREIT':Math.ceil(specCD)+'s',bx,by+br+14,9,rdy?'#FFA726':'#777');

// Boss HP
if(bossRef&&bossRef.hp>0){const bw=VW*.6,bxx=(VW-bw)/2;
 dT(bossRef.name,VW/2,56,11,'#FF5252','center',true);
 dBar(bxx,68,bw,10,bossRef.hp/bossRef.mhp,'#FF5252','rgba(0,0,0,.5)')}

// Pause btn
X.fillStyle='rgba(0,0,0,.25)';X.beginPath();X.roundRect(VW-46,VH-40,38,28,8);X.fill();
dT('‚è∏',VW-27,VH-26,13,'rgba(255,255,255,.5)');

// Minimap
const mw=55,mh=55,mx=VW-mw-8,my=85;
X.fillStyle='rgba(0,0,0,.35)';X.fillRect(mx,my,mw,mh);
const ms2=mw/worldW;X.fillStyle='#FF5252';
enemies.forEach(e=>{if(e.hp<=0)return;const s=e.isBoss?4:e.elite?3:1.5;X.fillRect(mx+e.x*ms2-s/2,my+e.y*ms2-s/2,s,s)});
X.fillStyle='#4CAF50';X.beginPath();X.arc(mx+P.x*ms2,my+P.y*ms2,2.5,0,PI2);X.fill();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MENU SCREENS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rMenu(){
menuA+=.016;const g=X.createLinearGradient(0,0,0,VH);
g.addColorStop(0,'#0a0a2e');g.addColorStop(.5,'#1a1035');g.addColorStop(1,'#0a0a2e');
X.fillStyle=g;X.fillRect(0,0,VW,VH);
const bge=['üìß','üìã','üìä','üìÖ','üêõ','üñ®Ô∏è','üò§','üßæ','üîç','üïê'];
for(let i=0;i<bge.length;i++){const ex=VW*(i/bge.length)+Math.sin(menuA+i*2)*30,ey=VH*.12+Math.sin(menuA*.7+i*3)*35+i*18;
 X.globalAlpha=.12;dE(bge[i],ex,ey,28);X.globalAlpha=1}
const ts=1+Math.sin(menuA*2)*.03;X.save();X.translate(VW/2,VH*.2);X.scale(ts,ts);
dT('üè¢',0,-28,clamp(VW*.08,28,45),'#fff');dT('B√úRO',0,8,clamp(VW*.09,26,44),'#fff','center',true);
dT('SURVIVORS',0,8+clamp(VW*.07,22,36),clamp(VW*.06,18,32),'#FF9800','center',true);X.restore();
dT('√úberlebe den B√ºroalltag!',VW/2,VH*.41,clamp(VW*.025,9,13),'rgba(170,170,255,.5)');
btns=[];
X.fillStyle='#E65100';X.beginPath();X.roundRect(VW/2-110,VH*.5-26,220,52,14);X.fill();X.strokeStyle='#FFA726';X.lineWidth=2;X.stroke();
dT('‚ñ∂  SPIELEN',VW/2,VH*.5,20,'#fff');btn(VW/2,VH*.5,220,52,()=>{state='charsel'});
X.fillStyle='rgba(255,255,255,.07)';X.beginPath();X.roundRect(VW/2-90,VH*.61-22,180,44,12);X.fill();X.strokeStyle='rgba(255,255,255,.18)';X.lineWidth=1;X.stroke();
dT('üõí SHOP',VW/2,VH*.61,16,'#fff');btn(VW/2,VH*.61,180,44,()=>{state='shop'});
X.fillStyle='rgba(255,255,255,.07)';X.beginPath();X.roundRect(VW/2-90,VH*.71-22,180,44,12);X.fill();X.strokeStyle='rgba(255,255,255,.18)';X.lineWidth=1;X.stroke();
dT('üìä STATS',VW/2,VH*.71,15,'#fff');btn(VW/2,VH*.71,180,44,()=>{state='stats'});
dT('Touch / WASD + Leertaste',VW/2,VH*.86,9,'rgba(255,255,255,.2)');
chkB(function(){const t=[...taps];taps=[];return t}());
}

function rCharSel(){
X.fillStyle='#0a0a2e';X.fillRect(0,0,VW,VH);dT('‚öîÔ∏è Held w√§hlen',VW/2,28,clamp(VW*.04,15,22),'#fff');
btns=[];const cols=3,cw=clamp(VW*.28,90,130),ch=140,gap=10,tw=cols*(cw+gap)-gap,sx=(VW-tw)/2;
CHARS.forEach((c,i)=>{const col=i%cols,row=Math.floor(i/cols),cx2=sx+col*(cw+gap),cy2=55+row*(ch+gap);
 const ul=save.unlocked.includes(i),sl=i===selChar;
 X.fillStyle=sl?'rgba(0,255,255,.1)':'rgba(255,255,255,.04)';X.strokeStyle=sl?'#00BCD4':'rgba(255,255,255,.12)';X.lineWidth=sl?2:1;
 X.beginPath();X.roundRect(cx2,cy2,cw,ch,12);X.fill();X.stroke();
 if(!ul){X.fillStyle='rgba(0,0,0,.55)';X.beginPath();X.roundRect(cx2,cy2,cw,ch,12);X.fill()}
 dE(ul?c.emoji:'üîí',cx2+cw/2,cy2+30,26);dT(c.name,cx2+cw/2,cy2+58,10,ul?'#fff':'#555');
 dT(c.desc,cx2+cw/2,cy2+73,8,ul?'#aaa':'#444');
 if(!ul)dT('ü™ô '+c.cost,cx2+cw/2,cy2+92,11,'#FFD740');
 else{dT(c.sN,cx2+cw/2,cy2+92,7,'#FFA726');dT(`HP:${c.hp} SPD:${Math.round(c.spd/10)}`,cx2+cw/2,cy2+106,7,'#8f8')}
 btn(cx2+cw/2,cy2+ch/2,cw,ch,()=>{if(ul)selChar=i;else if(save.coins>=c.cost){save.coins-=c.cost;save.unlocked.push(i);doS();selChar=i;sfx('power')}})});
const by=VH-85;X.fillStyle='#E65100';X.beginPath();X.roundRect(VW/2-100,by,200,44,12);X.fill();X.strokeStyle='#FFA726';X.lineWidth=2;X.stroke();
dT('‚öîÔ∏è LOS!',VW/2,by+22,18,'#fff');btn(VW/2,by+22,200,44,()=>{if(save.unlocked.includes(selChar))startGame()});
X.fillStyle='rgba(255,255,255,.06)';X.beginPath();X.roundRect(VW/2-70,VH-30,140,26,10);X.fill();
dT('‚Üê ZUR√úCK',VW/2,VH-17,11,'#888');btn(VW/2,VH-17,140,26,()=>{state='menu'});
chkB(function(){const t=[...taps];taps=[];return t}());
}

function rShop(){
X.fillStyle='#0a0a2e';X.fillRect(0,0,VW,VH);dT('üõí Shop',VW/2,25,20,'#FFD740');dT('ü™ô '+save.coins,VW/2,48,14,'#FFD740');
btns=[];const iw=clamp(VW*.42,125,170),ih=85,gap=10,cols=2,tw=cols*(iw+gap)-gap,sx=(VW-tw)/2;
SHOP.forEach((it,i)=>{const col=i%cols,row=Math.floor(i/cols),ix=sx+col*(iw+gap),iy=68+row*(ih+gap);
 const lvl=save.up[it.id]||0,mx=lvl>=it.max,co=it.cost+lvl*15;
 X.fillStyle='rgba(255,255,255,.04)';X.beginPath();X.roundRect(ix,iy,iw,ih,10);X.fill();
 X.strokeStyle=mx?'rgba(255,255,255,.08)':'rgba(255,255,255,.15)';X.lineWidth=1;X.stroke();
 if(mx){X.fillStyle='rgba(0,0,0,.25)';X.beginPath();X.roundRect(ix,iy,iw,ih,10);X.fill()}
 dE(it.emoji,ix+22,iy+22,18);dT(it.name,ix+iw/2+8,iy+17,10,mx?'#555':'#fff');
 dT(it.desc,ix+iw/2+8,iy+33,8,mx?'#444':'#aaa');dT(`Lv ${lvl}/${it.max}`,ix+iw/2+8,iy+50,8,'#777');
 dT(mx?'MAX':'ü™ô '+co,ix+iw/2+8,iy+67,11,mx?'#555':'#FFD740');
 btn(ix+iw/2,iy+ih/2,iw,ih,()=>{if(!mx&&save.coins>=co){save.coins-=co;save.up[it.id]=(save.up[it.id]||0)+1;doS();sfx('coin')}})});
X.fillStyle='rgba(255,255,255,.06)';X.beginPath();X.roundRect(VW/2-70,VH-36,140,28,10);X.fill();
dT('‚Üê ZUR√úCK',VW/2,VH-22,11,'#888');btn(VW/2,VH-22,140,28,()=>{state='menu'});
chkB(function(){const t=[...taps];taps=[];return t}());
}

function rStats(){
X.fillStyle='#0a0a2e';X.fillRect(0,0,VW,VH);dT('üìä Stats',VW/2,28,20,'#00BCD4');
const rows=[['Spiele',save.games],['Kills',save.totalKills],['Beste Zeit',fmtT(save.bestTime)],['Beste Welle',save.bestWave],['Kill-Rekord',save.bestKills],['Bester Combo',save.bestCombo+'x'],['M√ºnzen','ü™ô '+save.coins]];
rows.forEach((r,i)=>{const y=58+i*34;X.fillStyle=i%2?'rgba(255,255,255,.02)':'rgba(255,255,255,.05)';X.fillRect(VW*.08,y,VW*.84,28);
 dT(r[0],VW*.12,y+14,11,'#aaa','left');dT(''+r[1],VW*.88,y+14,12,'#fff','right')});
btns=[];X.fillStyle='rgba(255,255,255,.06)';X.beginPath();X.roundRect(VW/2-70,VH-36,140,28,10);X.fill();
dT('‚Üê ZUR√úCK',VW/2,VH-22,11,'#888');btn(VW/2,VH-22,140,28,()=>{state='menu'});
chkB(function(){const t=[...taps];taps=[];return t}());
}

function rUpg(){
X.fillStyle='rgba(0,0,0,.82)';X.fillRect(0,0,VW,VH);
dT('‚¨ÜÔ∏è LEVEL UP!',VW/2,VH*.1,clamp(VW*.05,18,28),'#FFD740','center',true);
dT('Level '+P.lv,VW/2,VH*.16,13,'#fff');
btns=[];const cw=Math.min(VW*.88,350),ch2=65,gap=12,sy=VH*.22;
const rc={common:'#666',rare:'#2196F3',epic:'#9C27B0'};
upChoices.forEach((u,i)=>{const cy=sy+i*(ch2+gap),cx2=(VW-cw)/2,c=rc[u.r]||'#666';
 X.fillStyle='rgba(30,15,60,.88)';X.beginPath();X.roundRect(cx2,cy,cw,ch2,14);X.fill();
 X.strokeStyle=c+'66';X.lineWidth=2;X.stroke();
 dE(u.emoji,cx2+30,cy+ch2/2,24);dT(u.name,cx2+58,cy+20,12,'#fff','left');dT(u.desc,cx2+58,cy+38,9,'#bbb','left');
 X.fillStyle=c;X.beginPath();X.roundRect(cx2+cw-55,cy+8,48,16,8);X.fill();
 dT(u.r.toUpperCase(),cx2+cw-31,cy+16,7,'#fff');
 btn(VW/2,cy+ch2/2,cw,ch2,()=>pickUP(u))});
chkB(function(){const t=[...taps];taps=[];return t}());
}

function rPause(){
X.fillStyle='rgba(0,0,0,.65)';X.fillRect(0,0,VW,VH);dT('‚è∏ PAUSE',VW/2,VH*.32,26,'#fff');
btns=[];
X.fillStyle='rgba(255,255,255,.08)';X.beginPath();X.roundRect(VW/2-100,VH*.46,200,44,12);X.fill();
dT('‚ñ∂ WEITER',VW/2,VH*.46+22,15,'#fff');btn(VW/2,VH*.46+22,200,44,()=>{state='playing'});
X.fillStyle='rgba(255,255,255,.08)';X.beginPath();X.roundRect(VW/2-100,VH*.56,200,44,12);X.fill();
dT('üè† K√úNDIGEN',VW/2,VH*.56+22,14,'#FF8A80');btn(VW/2,VH*.56+22,200,44,()=>{state='menu';P=null;clearRunSave()});
chkB(function(){const t=[...taps];taps=[];return t}());
}

function rGO(){
X.fillStyle='rgba(10,0,0,.9)';X.fillRect(0,0,VW,VH);
dT('üíÄ BURNOUT!',VW/2,VH*.11,clamp(VW*.06,22,34),'#FF1744','center',true);
const st=[['√úberlebt',fmtT(gameTime)],['Welle',WNAMES[Math.min(wave-1,WNAMES.length-1)]||''+wave],
 ['Level',''+P.lv],['Kills',''+kills],['Bester Combo',combo+'x'],['M√ºnzen','ü™ô '+coins]];
const bx2=(VW-250)/2,by2=VH*.22;
X.fillStyle='rgba(255,255,255,.04)';X.beginPath();X.roundRect(bx2,by2,250,st.length*26+14,12);X.fill();
st.forEach((s,i)=>{const sy2=by2+10+i*26;dT(s[0],bx2+14,sy2+8,10,'#aaa','left');dT(s[1],bx2+236,sy2+8,10,'#fff','right')});
btns=[];const by3=VH*.66;
X.fillStyle='#E65100';X.beginPath();X.roundRect(VW/2-100,by3,200,44,12);X.fill();X.strokeStyle='#FFA726';X.lineWidth=2;X.stroke();
dT('üîÑ NOCHMAL',VW/2,by3+22,15,'#fff');btn(VW/2,by3+22,200,44,()=>startGame());
X.fillStyle='rgba(255,255,255,.08)';X.beginPath();X.roundRect(VW/2-100,by3+54,200,38,12);X.fill();
dT('üè† MEN√ú',VW/2,by3+73,13,'#fff');btn(VW/2,by3+73,200,38,()=>{state='menu';P=null;clearRunSave()});
chkB(function(){const t=[...taps];taps=[];return t}());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN LOOP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
restoreRunIfAny();
let lastT=0;
function loop(ts){requestAnimationFrame(loop);if(!lastT)lastT=ts;let dt=(ts-lastT)/1000;lastT=ts;if(dt>.1)dt=.1;update(dt);render()}
requestAnimationFrame(loop);
</script>
</body>
</html>
